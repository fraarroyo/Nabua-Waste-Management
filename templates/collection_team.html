{% extends "base.html" %}

{% block title %}Collection Team - Waste Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-truck me-2"></i>Collection Team Dashboard
                    <span class="badge bg-light text-dark ms-2">Active Collections</span>
                    <span id="collector-location-status" class="badge bg-secondary ms-2" title="Collector location status">Location: unknown</span>
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted">View and manage pending waste collections by barangay</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Note:</strong> Waste items must be sorted before they can be collected. Items that are not sorted will show a "Not Sorted" badge and cannot be marked as collected.
                </div>
                
                {% if pending_collections %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Item Name</th>
                                    <th>Barangay</th>
                                    <th>Address</th>
                                    <th>Contact</th>
                                    <th>Waste Type</th>
                                    <th>Weight</th>
                                    <th>Sorted</th>
                                    <th>Registered</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in pending_collections %}
                                <tr>
                                    <td><code>{{ item.item_id }}</code></td>
                                    <td>{{ item.item_name }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ item.barangay.name }}</span>
                                    </td>
                                    <td>{{ item.address }}</td>
                                    <td>
                                        {% if item.contact_person %}
                                            <div class="small">
                                                <strong>{{ item.contact_person }}</strong><br>
                                                {% if item.contact_number %}
                                                    <i class="fas fa-phone me-1"></i>{{ item.contact_number }}
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No contact info</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge waste-type-badge bg-{{ 'primary' if item.waste_type == 'recyclable' else 'danger' if item.waste_type == 'hazardous' else 'success' if item.waste_type == 'organic' else 'secondary' }}">
                                            {{ item.waste_type.title() }}
                                        </span>
                                    </td>
                                    <td>{{ item.weight or 'N/A' }} kg</td>
                                    <td>
                                        {% if item.is_sorted %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle me-1"></i>Sorted
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times-circle me-1"></i>Not Sorted
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if item.is_sorted %}
                                            <form method="POST" action="{{ url_for('mark_collected', item_id=item.item_id) }}" class="d-inline collect-form">
                                                <input type="hidden" name="latitude" value="">
                                                <input type="hidden" name="longitude" value="">
                                                <button type="submit" class="btn btn-success btn-sm collect-btn" data-item-id="{{ item.item_id }}">
                                                    <i class="fas fa-check me-1"></i>Mark Collected
                                                </button>
                                            </form>
                                        {% else %}
                                            <button type="button" class="btn btn-secondary btn-sm" disabled title="Waste must be sorted before collection">
                                                <i class="fas fa-ban me-1"></i>Not Sorted
                                            </button>
                                        {% endif %}
                                        <a href="{{ url_for('view_item', item_id=item.item_id) }}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>No pending collections! All waste items have been collected.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Awaiting Client Confirmation Section -->
{% if awaiting_confirmation %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Awaiting Client Confirmation
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted">These items have been marked as collected and are waiting for client confirmation.</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Item Name</th>
                                <th>Barangay</th>
                                <th>Address</th>
                                <th>Contact</th>
                                <th>Collected At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in awaiting_confirmation %}
                            <tr>
                                <td><code>{{ item.item_id }}</code></td>
                                <td>{{ item.item_name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ item.barangay.name }}</span>
                                </td>
                                <td>{{ item.address }}</td>
                                <td>
                                    {% if item.contact_person %}
                                        <div class="small">
                                            <strong>{{ item.contact_person }}</strong><br>
                                            {% if item.contact_number %}
                                                <i class="fas fa-phone me-1"></i>{{ item.contact_number }}
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No contact info</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('view_item', item_id=item.item_id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Confirmed Collections (Barangay Representatives) -->
{% if confirmed_collections %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Confirmed Collections from Barangay Representatives
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted">Items that have been marked as collected by the collection team and **confirmed by the barangay representative/client**.</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Item Name</th>
                                <th>Barangay</th>
                                <th>Address</th>
                                <th>Confirmed At</th>
                                <th>Waste Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in confirmed_collections %}
                            <tr>
                                <td><code>{{ item.item_id }}</code></td>
                                <td>{{ item.item_name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ item.barangay.name }}</span>
                                </td>
                                <td>{{ item.address }}</td>
                                <td>
                                    {% if item.client_confirmed_at %}
                                        {{ item.client_confirmed_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge waste-type-badge bg-{{ 'primary' if item.waste_type == 'recyclable' else 'danger' if item.waste_type == 'hazardous' else 'success' if item.waste_type == 'organic' else 'secondary' }}">
                                        {{ item.waste_type.title() }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ url_for('view_item', item_id=item.item_id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Collection Statistics -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>{{ pending_collections|length }}</h3>
                <p class="mb-0">Pending Collections</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ pending_collections|groupby('barangay.name')|list|length }}</h3>
                <p class="mb-0">Barangays with Pending Items</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ pending_collections|selectattr('waste_type', 'equalto', 'hazardous')|list|length }}</h3>
                <p class="mb-0">Hazardous Items</p>
            </div>
        </div>
    </div>
</div>

<!-- Awaiting Confirmation Statistics -->
{% if awaiting_confirmation %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h3>{{ awaiting_confirmation|length }}</h3>
                <p class="mb-0">Items Awaiting Client Confirmation</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Status Updates Section -->
{% if status_updates %}
<!-- Status Updates Statistics -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ status_updates|selectattr('status', 'equalto', 'collected')|list|length }}</h3>
                <p class="mb-0">Collected</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ status_updates|selectattr('status', 'equalto', 'in_transit')|list|length }}</h3>
                <p class="mb-0">In Transit</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ status_updates|selectattr('status', 'equalto', 'processed')|list|length }}</h3>
                <p class="mb-0">Processed</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white">
            <div class="card-body text-center">
                <h3>{{ status_updates|selectattr('status', 'equalto', 'disposed')|list|length }}</h3>
                <p class="mb-0">Disposed</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-history me-2"></i>All Status Updates
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted">All items with status updates made by the collection team.</p>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item ID</th>
                                <th>Item Name</th>
                                <th>Barangay</th>
                                <th>Address</th>
                                <th>Current Status</th>
                                <th>Waste Type</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in status_updates %}
                            <tr>
                                <td><code>{{ item.item_id }}</code></td>
                                <td>{{ item.item_name }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ item.barangay.name }}</span>
                                </td>
                                <td>{{ item.address }}</td>
                                <td>
                                    {% if item.status == 'collected' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Collected
                                        </span>
                                    {% elif item.status == 'in_transit' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-truck me-1"></i>In Transit
                                        </span>
                                    {% elif item.status == 'processed' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-cog me-1"></i>Processed
                                        </span>
                                    {% elif item.status == 'disposed' %}
                                        <span class="badge bg-dark">
                                            <i class="fas fa-trash me-1"></i>Disposed
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ item.status.replace('_', ' ').title() }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge waste-type-badge bg-{{ 'primary' if item.waste_type == 'recyclable' else 'danger' if item.waste_type == 'hazardous' else 'success' if item.waste_type == 'organic' else 'secondary' }}">
                                        {{ item.waste_type.title() }}
                                    </span>
                                </td>
                                <td>{{ item.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <a href="{{ url_for('view_item', item_id=item.item_id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Capture GPS coordinates when collection team marks item as collected
document.addEventListener('DOMContentLoaded', function() {
    function submitWithCoords(form) {
        // If browser supports geolocation, try to get coords
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                form.querySelector('input[name="latitude"]').value = lat;
                form.querySelector('input[name="longitude"]').value = lng;
                form.submit();
            }, function(err) {
                // On error or denied permission, submit without coords
                form.submit();
            }, { enableHighAccuracy: true, timeout: 10000 });
        } else {
            form.submit();
        }
    }

    document.querySelectorAll('.collect-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = btn.closest('form');
            if (form) submitWithCoords(form);
        });
    });

    // Start background location pings for collectors
    const statusEl = document.getElementById('collector-location-status');
    if (navigator.geolocation && statusEl) {
        let lastPos = null;
        let watchId = null;
        const sendLocation = async (lat, lng) => {
            try {
                const resp = await fetch('/collector_location', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_latitude: lat, device_longitude: lng })
                });
                if (resp.ok) {
                    statusEl.className = 'badge bg-success ms-2';
                    statusEl.textContent = 'Location: ok';
                } else {
                    statusEl.className = 'badge bg-danger ms-2';
                    statusEl.textContent = 'Location: failed';
                }
            } catch (err) {
                statusEl.className = 'badge bg-danger ms-2';
                statusEl.textContent = 'Location: error';
            }
        };

        try {
            watchId = navigator.geolocation.watchPosition(function(p) {
                lastPos = p.coords;
                statusEl.className = 'badge bg-info ms-2';
                statusEl.textContent = 'Location: updating';
                // send immediately
                sendLocation(p.coords.latitude, p.coords.longitude);
            }, function(err) {
                if (err && err.code === err.PERMISSION_DENIED) {
                    statusEl.className = 'badge bg-warning ms-2';
                    statusEl.textContent = 'Location: permission denied';
                    if (watchId) navigator.geolocation.clearWatch(watchId);
                } else {
                    statusEl.className = 'badge bg-warning ms-2';
                    statusEl.textContent = 'Location: unavailable';
                }
            }, { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 });

            // Fallback periodic resend every 10s in case watchPosition doesn't fire
            setInterval(() => {
                if (lastPos) sendLocation(lastPos.latitude, lastPos.longitude);
            }, 10000);
        } catch (e) {
            statusEl.className = 'badge bg-warning ms-2';
            statusEl.textContent = 'Location: not supported';
        }
    }
});
</script>
{% endblock %}
